<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video-Deadline-Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
      --bg-light: #f8fafc;
      --bg-dark: #1e293b;
      --text-light: #1e293b;
      --text-dark: #f8fafc;
      --border-radius: 8px;
      --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --text: var(--text-dark);
      --card-bg: #334155;
    }

    [data-theme="light"] {
      --bg: var(--bg-light);
      --text: var(--text-light);
      --card-bg: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      transition: var(--transition);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 1.5rem;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .theme-toggle:hover {
      background: var(--card-bg);
    }

    .task-form {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      margin-bottom: 2rem;
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-group label {
      font-weight: 500;
      font-size: 0.875rem;
    }

    input, button {
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
      background: var(--bg);
      color: var(--text);
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: #16a34a;
    }

    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: var(--card-bg);
      border: 1px solid #e2e8f0;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .task-list {
      display: grid;
      gap: 1rem;
    }

    .task {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      display: grid;
      gap: 1rem;
      transition: var(--transition);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .task.urgent {
      border-left: 4px solid var(--danger);
    }

    .task.soon {
      border-left: 4px solid var(--warning);
    }

    .task.normal {
      border-left: 4px solid var(--success);
    }

    .task.completed {
      opacity: 0.7;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-title {
      font-weight: 600;
      font-size: 1.125rem;
    }

    .task-meta {
      display: flex;
      gap: 1rem;
      color: #64748b;
      font-size: 0.875rem;
    }

    .task-actions {
      display: flex;
      gap: 0.5rem;
    }

    .task-actions button {
      padding: 0.5rem;
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }

    @media (max-width: 640px) {
      body {
        padding: 1rem;
      }

      .task-form {
        grid-template-columns: 1fr;
      }

      .task-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .task-meta {
        flex-direction: column;
        gap: 0.25rem;
      }
    }

    .client-input-wrapper {
      position: relative;
    }

    .client-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid #e2e8f0;
      border-radius: var(--border-radius);
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      display: none;
    }

    .client-suggestions.active {
      display: block;
    }

    .client-suggestion {
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .client-suggestion:hover {
      background: var(--primary);
      color: white;
    }

    .client-suggestion i {
      margin-right: 0.5rem;
      color: #64748b;
    }

    .client-suggestion:hover i {
      color: white;
    }

    .sync-status {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      background: var(--card-bg);
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      z-index: 1000;
      transition: var(--transition);
    }

    .sync-status.syncing {
      background: var(--primary);
      color: white;
    }

    .sync-status.error {
      background: var(--danger);
      color: white;
    }

    .sync-status.success {
      background: var(--success);
      color: white;
    }

    .github-config {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      z-index: 1000;
      display: none;
    }

    .github-config.active {
      display: block;
    }

    .github-config h2 {
      margin-bottom: 1rem;
    }

    .github-config .form-group {
      margin-bottom: 1rem;
    }

    .github-config input {
      width: 100%;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }

    .overlay.active {
      display: block;
    }
  </style>
</head>
<body data-theme="light">
  <div class="container">
    <header>
      <h1>ðŸŽ¬ Video-Deadline-Manager</h1>
      <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
      </button>
    </header>

    <form class="task-form" onsubmit="addTask(event)">
      <div class="form-group">
        <label for="client">Kunde/Projekt</label>
        <div class="client-input-wrapper">
          <input 
            type="text" 
            id="client" 
            placeholder="z.B. Firma XYZ" 
            required 
            autocomplete="off"
            oninput="showClientSuggestions(this.value)"
            onfocus="showClientSuggestions(this.value)"
          />
          <div id="clientSuggestions" class="client-suggestions"></div>
        </div>
      </div>
      <div class="form-group">
        <label for="videos">Anzahl Videos</label>
        <input type="number" id="videos" min="1" placeholder="z.B. 3" required />
      </div>
      <div class="form-group">
        <label for="deadline">Deadline</label>
        <input type="date" id="deadline" required />
      </div>
      <div class="form-group">
        <label>&nbsp;</label>
        <button type="submit" class="btn">
          <i class="fas fa-plus"></i> Aufgabe hinzufÃ¼gen
        </button>
      </div>
    </form>

    <div class="filters">
      <button class="filter-btn active" onclick="filterTasks('all')">Alle</button>
      <button class="filter-btn" onclick="filterTasks('active')">Aktiv</button>
      <button class="filter-btn" onclick="filterTasks('completed')">Erledigt</button>
      <button class="filter-btn" onclick="filterTasks('urgent')">Dringend</button>
    </div>

    <div id="taskList" class="task-list"></div>
  </div>

  <div id="syncStatus" class="sync-status">
    <i class="fas fa-sync"></i>
    <span>Nicht synchronisiert</span>
  </div>

  <!-- GitHub Konfigurationsdialog -->
  <div id="overlay" class="overlay"></div>
  <div id="githubConfig" class="github-config">
    <h2>GitHub Konfiguration</h2>
    <div class="form-group">
      <label for="githubToken">GitHub Personal Access Token</label>
      <input type="password" id="githubToken" placeholder="ghp_..." />
      <small>Erstelle einen Token mit 'repo' Berechtigung unter GitHub Settings > Developer Settings > Personal Access Tokens</small>
    </div>
    <div class="form-group">
      <button class="btn" onclick="saveGitHubConfig()">Speichern</button>
    </div>
  </div>

  <!-- Konfiguration fÃ¼r GitHub Actions -->
  <script>
    window.GITHUB_CONFIG = {
      // Repository-Name ohne Owner (wird automatisch ergÃ¤nzt)
      repo: "portfolio",
      // Owner des Repositories
      owner: "lennart168",
      // Token wird aus dem localStorage geladen
      get token() {
        return localStorage.getItem('github_token');
      },
      set token(value) {
        localStorage.setItem('github_token', value);
      }
    };
  </script>
  
  <!-- Hauptskript -->
  <script>
    let tasks = [];
    let currentFilter = 'all';
    let syncInProgress = false;

    // Entferne den Konfigurationsdialog und Overlay
    document.getElementById('overlay')?.remove();
    document.getElementById('githubConfig')?.remove();

    // Funktion zum Aktualisieren der Kundenliste
    function updateClientList() {
      const uniqueClients = [...new Set(tasks.map(task => task.client))].sort();
      return uniqueClients;
    }

    function showClientSuggestions(input) {
      const suggestionsDiv = document.getElementById('clientSuggestions');
      const inputValue = input.toLowerCase().trim();
      const clients = updateClientList();
      
      if (!inputValue) {
        suggestionsDiv.innerHTML = '';
        suggestionsDiv.classList.remove('active');
        return;
      }

      const filteredClients = clients.filter(client => 
        client.toLowerCase().includes(inputValue)
      );

      if (filteredClients.length === 0) {
        suggestionsDiv.innerHTML = '';
        suggestionsDiv.classList.remove('active');
        return;
      }

      suggestionsDiv.innerHTML = filteredClients
        .map(client => `
          <div class="client-suggestion" onclick="selectClient('${client}')">
            <i class="fas fa-building"></i>${client}
          </div>
        `)
        .join('');
      
      suggestionsDiv.classList.add('active');
    }

    function selectClient(client) {
      document.getElementById('client').value = client;
      document.getElementById('clientSuggestions').classList.remove('active');
    }

    // SchlieÃŸe VorschlÃ¤ge beim Klick auÃŸerhalb
    document.addEventListener('click', (e) => {
      const suggestionsDiv = document.getElementById('clientSuggestions');
      const clientInput = document.getElementById('client');
      
      if (!clientInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.classList.remove('active');
      }
    });

    function saveTasks() {
      tasks.forEach(task => {
        if (!task.updatedAt) {
          task.updatedAt = new Date().toISOString();
        }
      });
      syncTasks();
    }

    function toggleTheme() {
      const body = document.body;
      const theme = body.getAttribute('data-theme');
      const newTheme = theme === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const icon = document.querySelector('.theme-toggle i');
      icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }

    function addTask(event) {
      event.preventDefault();
      
      const client = document.getElementById("client").value.trim();
      const videos = parseInt(document.getElementById("videos").value);
      const deadline = document.getElementById("deadline").value;

      if (!client || !videos || !deadline) return;

      const task = {
        id: Date.now(),
        client,
        videos,
        deadline,
        done: false,
        createdAt: new Date().toISOString()
      };

      tasks.unshift(task);
      saveTasks();
      renderTasks();

      event.target.reset();
    }

    function filterTasks(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(filter));
      });
      renderTasks();
    }

    function getTaskStatus(task) {
      const deadlineDate = new Date(task.deadline);
      const today = new Date();
      const daysLeft = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

      if (task.done) return 'completed';
      if (daysLeft < 2) return 'urgent';
      if (daysLeft < 7) return 'soon';
      return 'normal';
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('de-DE', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function renderTasks() {
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";

      const filteredTasks = tasks.filter(task => {
        if (currentFilter === 'all') return true;
        if (currentFilter === 'active') return !task.done;
        if (currentFilter === 'completed') return task.done;
        if (currentFilter === 'urgent') return getTaskStatus(task) === 'urgent' && !task.done;
        return true;
      });

      if (filteredTasks.length === 0) {
        taskList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-clipboard-list fa-3x"></i>
            <p>Keine Aufgaben gefunden</p>
          </div>
        `;
        return;
      }

      filteredTasks.forEach(task => {
        const status = getTaskStatus(task);
        const div = document.createElement("div");
        div.className = `task ${status} ${task.done ? "completed" : ""}`;
        
        div.innerHTML = `
          <div class="task-header">
            <div class="task-title">${task.client}</div>
            <div class="task-meta">
              <span><i class="fas fa-video"></i> ${task.videos} Videos</span>
              <span><i class="fas fa-calendar"></i> ${formatDate(task.deadline)}</span>
            </div>
          </div>
          <div class="task-actions">
            <button onclick="toggleDone(${task.id})" class="btn ${task.done ? 'btn-danger' : 'btn-success'}">
              <i class="fas ${task.done ? 'fa-undo' : 'fa-check'}"></i>
              ${task.done ? 'RÃ¼ckgÃ¤ngig' : 'Erledigt'}
            </button>
            <button onclick="deleteTask(${task.id})" class="btn btn-danger">
              <i class="fas fa-trash"></i> LÃ¶schen
            </button>
          </div>
        `;
        taskList.appendChild(div);
      });
    }

    function toggleDone(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        task.done = !task.done;
        saveTasks();
        renderTasks();
      }
    }

    function deleteTask(taskId) {
      if (confirm("MÃ¶chten Sie diese Aufgabe wirklich lÃ¶schen?")) {
        tasks = tasks.filter(t => t.id !== taskId);
        saveTasks();
        renderTasks();
      }
    }

    // Funktion zum Anzeigen/Ausblenden des Konfigurationsdialogs
    function showGitHubConfig(show = true) {
      const config = document.getElementById('githubConfig');
      const overlay = document.getElementById('overlay');
      if (config && overlay) {
        if (show) {
          config.classList.add('active');
          overlay.classList.add('active');
        } else {
          config.classList.remove('active');
          overlay.classList.remove('active');
        }
      }
    }

    // Modifiziere die checkGitHubConfig Funktion
    function checkGitHubConfig() {
      if (!GITHUB_CONFIG.token) {
        showGitHubConfig(true);
        return false;
      }
      return true;
    }

    // Modifiziere die saveGitHubConfig Funktion
    function saveGitHubConfig() {
      const tokenInput = document.getElementById('githubToken');
      if (!tokenInput) return;

      const token = tokenInput.value.trim();
      if (!token) {
        alert('Bitte geben Sie einen Token ein');
        return;
      }
      
      GITHUB_CONFIG.token = token;
      showGitHubConfig(false);
      
      // Teste den Token
      testGitHubAccess().then(() => {
        updateSyncStatus('success', 'Token gespeichert');
        // Lade die Daten neu
        syncTasks();
      }).catch(error => {
        updateSyncStatus('error', `Token ungÃ¼ltig: ${error.message}`);
        // Zeige den Konfigurationsdialog wieder an
        showGitHubConfig(true);
      });
    }

    // Modifiziere die updateFileContent Funktion
    async function updateFileContent(content, sha) {
      if (!checkGitHubConfig()) {
        throw new Error('Bitte konfigurieren Sie zuerst den GitHub Token');
      }
      try {
        console.log('Aktualisiere Daten auf GitHub...');
        const repoPath = `${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`;
        
        if (!GITHUB_CONFIG.token) {
          throw new Error('Kein Token fÃ¼r die GitHub API konfiguriert');
        }

        // Wenn keine SHA vorhanden ist, versuche sie zu holen
        if (!sha) {
          const existingData = await getFileContent();
          if (existingData) {
            sha = existingData.sha;
            console.log('Gefundene SHA:', sha);
          }
        }

        const response = await fetch(
          `https://api.github.com/repos/${repoPath}/contents/tasks/data.json`,
          {
            method: 'PUT',
            headers: {
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json',
              'Authorization': `token ${GITHUB_CONFIG.token}`,
              'User-Agent': 'Video-Tasks-Manager'
            },
            body: JSON.stringify({
              message: 'Update tasks',
              content: btoa(JSON.stringify(content, null, 2)),
              sha: sha || null,
              branch: 'main'
            })
          }
        );

        console.log('GitHub API Response Status:', response.status);
        const responseText = await response.text();
        console.log('GitHub API Response:', responseText);

        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('UngÃ¼ltiger Token. Bitte erstellen Sie einen neuen Token mit "repo" Scope.');
          }
          throw new Error(`GitHub API Fehler (${response.status}): ${responseText}`);
        }

        console.log('Daten erfolgreich aktualisiert');
        return true;
      } catch (error) {
        console.error('Fehler beim Aktualisieren:', error);
        updateSyncStatus('error', `Fehler beim Speichern: ${error.message}`);
        return false;
      }
    }

    // Modifiziere die getFileContent Funktion
    async function getFileContent() {
      if (!checkGitHubConfig()) {
        throw new Error('Bitte konfigurieren Sie zuerst den GitHub Token');
      }
      try {
        console.log('Lade Daten von GitHub...');
        const repoPath = `${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`;
        
        const response = await fetch(
          `https://api.github.com/repos/${repoPath}/contents/tasks/data.json`,
          {
            headers: {
              'Accept': 'application/vnd.github.v3+json',
              'Authorization': `token ${GITHUB_CONFIG.token}`,
              'User-Agent': 'Video-Tasks-Manager'
            }
          }
        );

        if (response.status === 404) {
          console.log('Datei existiert noch nicht');
          return null;
        }

        if (!response.ok) {
          throw new Error(`Fehler beim Laden (${response.status}): ${await response.text()}`);
        }

        const data = await response.json();
        console.log('Daten erfolgreich geladen, SHA:', data.sha);
        return {
          content: JSON.parse(atob(data.content)),
          sha: data.sha
        };
      } catch (error) {
        console.error('Fehler beim Laden:', error);
        updateSyncStatus('error', `Fehler beim Laden: ${error.message}`);
        return null;
      }
    }

    // Modifiziere die testGitHubAccess Funktion
    async function testGitHubAccess() {
      if (!checkGitHubConfig()) {
        throw new Error('Bitte konfigurieren Sie zuerst den GitHub Token');
      }
      try {
        console.log('Teste GitHub-Zugriff...');
        const repoPath = `${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`;
        console.log('Repository:', repoPath);
        
        // Teste Repository-Zugriff
        const response = await fetch(
          `https://api.github.com/repos/${repoPath}`,
          {
            headers: {
              'Accept': 'application/vnd.github.v3+json',
              'User-Agent': 'Video-Tasks-Manager'
            }
          }
        );

        console.log('Repository Test Status:', response.status);
        const responseText = await response.text();
        console.log('Repository Test Response:', responseText);

        if (!response.ok) {
          throw new Error(`Repository nicht gefunden (${response.status}): ${responseText}`);
        }

        // Teste tasks-Ordner-Zugriff
        const tasksResponse = await fetch(
          `https://api.github.com/repos/${repoPath}/contents/tasks`,
          {
            headers: {
              'Accept': 'application/vnd.github.v3+json',
              'User-Agent': 'Video-Tasks-Manager'
            }
          }
        );

        console.log('Tasks-Ordner Test Status:', tasksResponse.status);
        const tasksResponseText = await tasksResponse.text();
        console.log('Tasks-Ordner Test Response:', tasksResponseText);

        if (!tasksResponse.ok && tasksResponse.status !== 404) {
          throw new Error(`Fehler beim Zugriff auf tasks-Ordner (${tasksResponse.status}): ${tasksResponseText}`);
        }

        return {
          repositoryAccess: response.ok,
          tasksFolderExists: tasksResponse.ok
        };
      } catch (error) {
        console.error('GitHub-Zugriffstest fehlgeschlagen:', error);
        throw error;
      }
    }

    async function syncTasks() {
      if (syncInProgress) return;
      syncInProgress = true;
      updateSyncStatus('syncing', 'Synchronisiere...');

      try {
        // Versuche zuerst, die Datei zu erstellen, wenn sie nicht existiert
        const existingData = await getFileContent();
        console.log('Vorhandene Daten:', existingData ? 'Ja' : 'Nein');
        
        if (!existingData) {
          console.log('Erstelle neue Datei mit', tasks.length, 'Tasks');
          // Stelle sicher, dass wir ein leeres Array haben, wenn keine Tasks vorhanden sind
          if (!Array.isArray(tasks)) {
            tasks = [];
          }
          const success = await updateFileContent(tasks, null);
          if (success) {
            updateSyncStatus('success', 'Synchronisiert');
            return;
          }
        } else {
          // Wenn die Datei existiert, merge die Daten
          const remoteTasks = existingData.content;
          console.log('Remote Tasks:', remoteTasks.length);
          console.log('Lokale Tasks:', tasks.length);
          
          // Stelle sicher, dass remoteTasks ein Array ist
          const mergedTasks = Array.isArray(remoteTasks) ? [...remoteTasks] : [];
          
          // FÃ¼ge neue lokale Tasks hinzu
          if (Array.isArray(tasks)) {
            tasks.forEach(localTask => {
              const existingIndex = mergedTasks.findIndex(t => t.id === localTask.id);
              if (existingIndex === -1) {
                mergedTasks.push(localTask);
              } else if (localTask.updatedAt > mergedTasks[existingIndex].updatedAt) {
                mergedTasks[existingIndex] = localTask;
              }
            });
          }

          tasks = mergedTasks;
          console.log('Nach Merge:', tasks.length, 'Tasks');

          // Speichere aktualisierte Daten mit der bekannten SHA
          const success = await updateFileContent(tasks, existingData.sha);
          if (success) {
            updateSyncStatus('success', 'Synchronisiert');
            renderTasks();
          }
        }
      } catch (error) {
        console.error('Synchronisationsfehler:', error);
        updateSyncStatus('error', `Synchronisationsfehler: ${error.message}`);
      } finally {
        syncInProgress = false;
      }
    }

    function updateSyncStatus(status, message) {
      const syncStatus = document.getElementById('syncStatus');
      syncStatus.className = `sync-status ${status}`;
      syncStatus.innerHTML = `
        <i class="fas fa-${status === 'syncing' ? 'sync fa-spin' : 
                        status === 'error' ? 'exclamation-circle' : 
                        'check-circle'}"></i>
        <span>${message}</span>
      `;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      const icon = document.querySelector('.theme-toggle i');
      if (icon) {
        icon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
      }

      // PrÃ¼fe, ob ein Token vorhanden ist
      if (!GITHUB_CONFIG.token) {
        showGitHubConfig(true);
        return;
      }

      try {
        // Teste GitHub-Zugriff beim Start
        await testGitHubAccess();
        
        // Lade initial Daten
        const existingData = await getFileContent();
        if (existingData) {
          tasks = existingData.content;
        }
        renderTasks();
      } catch (error) {
        console.error('Initialisierungsfehler:', error);
        updateSyncStatus('error', `Initialisierungsfehler: ${error.message}`);
        // Zeige den Konfigurationsdialog an
        showGitHubConfig(true);
      }
    });
  </script>
</body>
</html>